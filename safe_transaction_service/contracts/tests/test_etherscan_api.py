from django.test import TestCase

from gnosis.eth.ethereum_client import EthereumNetwork

from ..clients import EtherscanApi
from ..clients.etherscan_api import RateLimitError


class TestEtherscanApi(TestCase):
    def test_etherscan_get_abi(self):
        try:
            etherscan_api = EtherscanApi(EthereumNetwork.MAINNET)
            safe_master_copy_abi = [{'constant': True, 'inputs': [{'internalType': 'bytes', 'name': 'message', 'type': 'bytes'}], 'name': 'getMessageHash', 'outputs': [{'internalType': 'bytes32', 'name': '', 'type': 'bytes32'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': 'owner', 'type': 'address'}, {'internalType': 'uint256', 'name': '_threshold', 'type': 'uint256'}], 'name': 'addOwnerWithThreshold', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'DOMAIN_SEPARATOR_TYPEHASH', 'outputs': [{'internalType': 'bytes32', 'name': '', 'type': 'bytes32'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'bytes', 'name': '_data', 'type': 'bytes'}, {'internalType': 'bytes', 'name': '_signature', 'type': 'bytes'}], 'name': 'isValidSignature', 'outputs': [{'internalType': 'bytes4', 'name': '', 'type': 'bytes4'}], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [{'internalType': 'address', 'name': 'owner', 'type': 'address'}], 'name': 'isOwner', 'outputs': [{'internalType': 'bool', 'name': '', 'type': 'bool'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': 'to', 'type': 'address'}, {'internalType': 'uint256', 'name': 'value', 'type': 'uint256'}, {'internalType': 'bytes', 'name': 'data', 'type': 'bytes'}, {'internalType': 'enum Enum.Operation', 'name': 'operation', 'type': 'uint8'}], 'name': 'execTransactionFromModule', 'outputs': [{'internalType': 'bool', 'name': 'success', 'type': 'bool'}], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': 'to', 'type': 'address'}, {'internalType': 'uint256', 'name': 'value', 'type': 'uint256'}, {'internalType': 'bytes', 'name': 'data', 'type': 'bytes'}, {'internalType': 'enum Enum.Operation', 'name': 'operation', 'type': 'uint8'}], 'name': 'execTransactionFromModuleReturnData', 'outputs': [{'internalType': 'bool', 'name': 'success', 'type': 'bool'}, {'internalType': 'bytes', 'name': 'returnData', 'type': 'bytes'}], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [{'internalType': 'bytes32', 'name': '', 'type': 'bytes32'}], 'name': 'signedMessages', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'contract Module', 'name': 'module', 'type': 'address'}], 'name': 'enableModule', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'uint256', 'name': '_threshold', 'type': 'uint256'}], 'name': 'changeThreshold', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': 'to', 'type': 'address'}, {'internalType': 'uint256', 'name': 'value', 'type': 'uint256'}, {'internalType': 'bytes', 'name': 'data', 'type': 'bytes'}, {'internalType': 'enum Enum.Operation', 'name': 'operation', 'type': 'uint8'}, {'internalType': 'uint256', 'name': 'safeTxGas', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'baseGas', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'gasPrice', 'type': 'uint256'}, {'internalType': 'address', 'name': 'gasToken', 'type': 'address'}, {'internalType': 'address payable', 'name': 'refundReceiver', 'type': 'address'}, {'internalType': 'bytes', 'name': 'signatures', 'type': 'bytes'}], 'name': 'execTransaction', 'outputs': [{'internalType': 'bool', 'name': 'success', 'type': 'bool'}], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [{'internalType': 'address', 'name': '', 'type': 'address'}, {'internalType': 'bytes32', 'name': '', 'type': 'bytes32'}], 'name': 'approvedHashes', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': '_masterCopy', 'type': 'address'}], 'name': 'changeMasterCopy', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'bytes', 'name': '_data', 'type': 'bytes'}], 'name': 'signMessage', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'SENTINEL_MODULES', 'outputs': [{'internalType': 'address', 'name': '', 'type': 'address'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'SENTINEL_OWNERS', 'outputs': [{'internalType': 'address', 'name': '', 'type': 'address'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'getOwners', 'outputs': [{'internalType': 'address[]', 'name': '', 'type': 'address[]'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'NAME', 'outputs': [{'internalType': 'string', 'name': '', 'type': 'string'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'nonce', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'getModules', 'outputs': [{'internalType': 'address[]', 'name': '', 'type': 'address[]'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address[]', 'name': '_owners', 'type': 'address[]'}, {'internalType': 'uint256', 'name': '_threshold', 'type': 'uint256'}, {'internalType': 'address', 'name': 'to', 'type': 'address'}, {'internalType': 'bytes', 'name': 'data', 'type': 'bytes'}, {'internalType': 'address', 'name': 'fallbackHandler', 'type': 'address'}, {'internalType': 'address', 'name': 'paymentToken', 'type': 'address'}, {'internalType': 'uint256', 'name': 'payment', 'type': 'uint256'}, {'internalType': 'address payable', 'name': 'paymentReceiver', 'type': 'address'}], 'name': 'setup', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'SAFE_MSG_TYPEHASH', 'outputs': [{'internalType': 'bytes32', 'name': '', 'type': 'bytes32'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': 'to', 'type': 'address'}, {'internalType': 'uint256', 'name': 'value', 'type': 'uint256'}, {'internalType': 'bytes', 'name': 'data', 'type': 'bytes'}, {'internalType': 'enum Enum.Operation', 'name': 'operation', 'type': 'uint8'}], 'name': 'requiredTxGas', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'SAFE_TX_TYPEHASH', 'outputs': [{'internalType': 'bytes32', 'name': '', 'type': 'bytes32'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'bytes32', 'name': 'hashToApprove', 'type': 'bytes32'}], 'name': 'approveHash', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [{'internalType': 'address', 'name': 'to', 'type': 'address'}, {'internalType': 'uint256', 'name': 'value', 'type': 'uint256'}, {'internalType': 'bytes', 'name': 'data', 'type': 'bytes'}, {'internalType': 'enum Enum.Operation', 'name': 'operation', 'type': 'uint8'}, {'internalType': 'uint256', 'name': 'safeTxGas', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'baseGas', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'gasPrice', 'type': 'uint256'}, {'internalType': 'address', 'name': 'gasToken', 'type': 'address'}, {'internalType': 'address', 'name': 'refundReceiver', 'type': 'address'}, {'internalType': 'uint256', 'name': '_nonce', 'type': 'uint256'}], 'name': 'getTransactionHash', 'outputs': [{'internalType': 'bytes32', 'name': '', 'type': 'bytes32'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'contract Module', 'name': 'prevModule', 'type': 'address'}, {'internalType': 'contract Module', 'name': 'module', 'type': 'address'}], 'name': 'disableModule', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': 'prevOwner', 'type': 'address'}, {'internalType': 'address', 'name': 'oldOwner', 'type': 'address'}, {'internalType': 'address', 'name': 'newOwner', 'type': 'address'}], 'name': 'swapOwner', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'getThreshold', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': True, 'inputs': [{'internalType': 'address', 'name': 'to', 'type': 'address'}, {'internalType': 'uint256', 'name': 'value', 'type': 'uint256'}, {'internalType': 'bytes', 'name': 'data', 'type': 'bytes'}, {'internalType': 'enum Enum.Operation', 'name': 'operation', 'type': 'uint8'}, {'internalType': 'uint256', 'name': 'safeTxGas', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'baseGas', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'gasPrice', 'type': 'uint256'}, {'internalType': 'address', 'name': 'gasToken', 'type': 'address'}, {'internalType': 'address', 'name': 'refundReceiver', 'type': 'address'}, {'internalType': 'uint256', 'name': '_nonce', 'type': 'uint256'}], 'name': 'encodeTransactionData', 'outputs': [{'internalType': 'bytes', 'name': '', 'type': 'bytes'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': 'handler', 'type': 'address'}], 'name': 'setFallbackHandler', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'domainSeparator', 'outputs': [{'internalType': 'bytes32', 'name': '', 'type': 'bytes32'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'constant': False, 'inputs': [{'internalType': 'address', 'name': 'prevOwner', 'type': 'address'}, {'internalType': 'address', 'name': 'owner', 'type': 'address'}, {'internalType': 'uint256', 'name': '_threshold', 'type': 'uint256'}], 'name': 'removeOwner', 'outputs': [], 'payable': False, 'stateMutability': 'nonpayable', 'type': 'function'}, {'constant': True, 'inputs': [], 'name': 'VERSION', 'outputs': [{'internalType': 'string', 'name': '', 'type': 'string'}], 'payable': False, 'stateMutability': 'view', 'type': 'function'}, {'payable': True, 'stateMutability': 'payable', 'type': 'fallback'}, {'anonymous': False, 'inputs': [{'indexed': True, 'internalType': 'bytes32', 'name': 'approvedHash', 'type': 'bytes32'}, {'indexed': True, 'internalType': 'address', 'name': 'owner', 'type': 'address'}], 'name': 'ApproveHash', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': True, 'internalType': 'bytes32', 'name': 'msgHash', 'type': 'bytes32'}], 'name': 'SignMsg', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'bytes32', 'name': 'txHash', 'type': 'bytes32'}, {'indexed': False, 'internalType': 'uint256', 'name': 'payment', 'type': 'uint256'}], 'name': 'ExecutionFailure', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'bytes32', 'name': 'txHash', 'type': 'bytes32'}, {'indexed': False, 'internalType': 'uint256', 'name': 'payment', 'type': 'uint256'}], 'name': 'ExecutionSuccess', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'address', 'name': 'from', 'type': 'address'}, {'indexed': False, 'internalType': 'uint256', 'name': 'value', 'type': 'uint256'}], 'name': 'IncomingTransaction', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'address', 'name': 'owner', 'type': 'address'}], 'name': 'AddedOwner', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'address', 'name': 'owner', 'type': 'address'}], 'name': 'RemovedOwner', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'uint256', 'name': 'threshold', 'type': 'uint256'}], 'name': 'ChangedThreshold', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'contract Module', 'name': 'module', 'type': 'address'}], 'name': 'EnabledModule', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'contract Module', 'name': 'module', 'type': 'address'}], 'name': 'DisabledModule', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': True, 'internalType': 'address', 'name': 'module', 'type': 'address'}], 'name': 'ExecutionFromModuleSuccess', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': True, 'internalType': 'address', 'name': 'module', 'type': 'address'}], 'name': 'ExecutionFromModuleFailure', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'address', 'name': 'newContract', 'type': 'address'}], 'name': 'ContractCreation', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'address', 'name': 'masterCopy', 'type': 'address'}], 'name': 'ChangedMasterCopy', 'type': 'event'}]
            self.assertEqual(etherscan_api.get_contract_abi('0xaE32496491b53841efb51829d6f886387708F99B'),
                             safe_master_copy_abi)

            self.assertIsNone(etherscan_api.get_contract_abi('0xaE32496491b53841efb51829d6f886387708F99a'))
        except RateLimitError:
            self.skipTest('Etherscan rate limit reached')
